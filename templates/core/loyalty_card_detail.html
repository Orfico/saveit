<!-- core/templates/core/loyalty_card_detail.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}{{ card.store_name }} - SaveIt{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
    @media print {
        body * {
            visibility: hidden;
        }
        #barcode-container, #barcode-container * {
            visibility: visible;
        }
        #barcode-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        nav, footer, .action-buttons {
            display: none !important;
        }
    }
    
    /* Landscape mode optimization */
    .barcode-fullscreen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 80vh;
        padding: 1rem;
    }
    
    .barcode-image-container {
        width: 100%;
        max-width: 90vw;
        display: flex;
        justify-content: center;
        margin: 2rem 0;
    }
    
    .barcode-image-container img {
        width: 100%;
        height: auto;
        max-height: 60vh;
        object-fit: contain;
    }
    
    .card-number-display {
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: 0.1em;
        color: #1f2937;
        text-align: center;
        margin-top: 1rem;
        word-break: break-all;
    }
    
    /* Mobile landscape optimization */
    @media screen and (orientation: landscape) and (max-width: 896px) {
        .barcode-fullscreen {
            min-height: 85vh;
        }
        
        .barcode-image-container img {
            max-height: 70vh;
        }
        
        .card-number-display {
            font-size: 1rem;
        }
        
        .action-buttons button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-4">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg shadow-lg p-6 mb-6">
        <h1 class="text-2xl font-bold mb-2">{{ card.store_name }}</h1>
        <p class="text-indigo-100 text-sm">Created: {{ card.created_at|date:"M d, Y" }}</p>
    </div>

    <!-- Barcode Display -->
    <div id="barcode-container" class="bg-white rounded-lg shadow-lg p-6 mb-6 barcode-fullscreen">
        <div class="barcode-image-container">
            {% if card.barcode_image %}
                <img 
                    src="https://wfoxqvvkutzbbphbbvvh.supabase.co/storage/v1/object/public/media/{{ card.barcode_image }}" 
                    alt="Barcode for {{ card.store_name }}"
                    id="barcode-image"
                    class="rounded-lg"
                >
            {% else %}
                <div class="text-center text-gray-500">
                    <p>No barcode available</p>
                </div>
            {% endif %}
        </div>
        
        <div class="card-number-display">
            {{ card.card_number }}
        </div>
        
        {% if card.notes %}
        <div class="mt-4 text-center">
            <p class="text-sm text-gray-600">{{ card.notes }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <button 
            onclick="printBarcode()" 
            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow transition duration-200 flex items-center justify-center gap-2"
        >
            <i data-lucide="printer" class="w-5 h-5"></i>
            <span>Print</span>
        </button>
        
        <button 
            onclick="downloadBarcode()" 
            class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow transition duration-200 flex items-center justify-center gap-2"
        >
            <i data-lucide="download" class="w-5 h-5"></i>
            <span>Download</span>
        </button>
        
        <button 
            onclick="shareBarcode()" 
            class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg shadow transition duration-200 flex items-center justify-center gap-2"
        >
            <i data-lucide="share-2" class="w-5 h-5"></i>
            <span>Share</span>
        </button>
        
        <button 
            onclick="deleteCard()" 
            class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow transition duration-200 flex items-center justify-center gap-2"
        >
            <i data-lucide="trash-2" class="w-5 h-5"></i>
            <span>Delete</span>
        </button>
    </div>

    <!-- Back Button -->
    <div class="text-center">
        <a 
            href="{% url 'core:loyalty_cards_list' %}" 
            class="inline-flex items-center gap-2 text-indigo-600 hover:text-indigo-700 font-semibold"
        >
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
            Back to Cards
        </a>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<div 
    id="card-data" 
    data-card-id="{{ card.id }}"
    data-store-name="{{ card.store_name }}"
    data-card-number="{{ card.card_number }}"
    data-barcode-url="https://wfoxqvvkutzbbphbbvvh.supabase.co/storage/v1/object/public/media/{{ card.barcode_image }}"
    style="display: none;"
></div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/loyalty_card_detail.js' %}"></script>
<script>
    // Force landscape orientation on mobile
    if (window.screen && window.screen.orientation) {
        try {
            screen.orientation.lock('landscape').catch(err => {
                console.log('Orientation lock not supported or denied:', err);
            });
        } catch (e) {
            console.log('Screen orientation API not supported');
        }
    }
    
    // Unlock orientation when leaving the page
    window.addEventListener('beforeunload', () => {
        if (window.screen && window.screen.orientation && screen.orientation.unlock) {
            try {
                screen.orientation.unlock();
            } catch (e) {
                console.log('Could not unlock orientation');
            }
        }
    });
</script>
{% endblock %}