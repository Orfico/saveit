{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Modifica{% else %}Nuova{% endif %} Transazione{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg">
  <h1 class="text-3xl font-bold mb-8 text-gray-800 flex items-center gap-3">
    {% if form.instance.pk %}
      <i data-lucide="edit" class="w-4 h-4"></i> Modifica Transazione
    {% else %}
      <i data-lucide="plus" class="w-4 h-4"></i> Nuova Transazione
    {% endif %}
  </h1>
  
  <form method="post" class="space-y-6" id="transactionForm">
    {% csrf_token %}
    
    <!-- Tipo Transazione (NUOVO) -->
    <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-200">
      <label class="block text-sm font-medium text-gray-700 mb-3"><i data-lucide="activity" class="w-4 h-4"></i> Tipo di Transazione</label>
      <div class="flex gap-6">
        {% for value, label in form.transaction_type.field.choices %}
        <label class="flex items-center space-x-2 cursor-pointer">
          <input type="radio" name="transaction_type" value="{{ value }}" 
                 {% if form.transaction_type.value == value %}checked{% endif %}
                 class="w-4 h-4 text-blue-600 focus:ring-blue-500">
          <span class="text-lg">{{ label }}</span>
        </label>
        {% endfor %}
      </div>
      {% if form.transaction_type.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.transaction_type.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- Data -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2"><i data-lucide="calendar" class="w-4 h-4"></i> Data</label>
      {{ form.date }}
      {% if form.date.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.date.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- Importo (MODIFICATO) -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2"><i data-lucide="dollar-sign" class="w-4 h-4"></i> Importo (€)</label>
      {{ form.amount }}
      <p class="text-xs text-gray-600 mt-1">Inserisci sempre un valore positivo (es: 50.00)</p>
      {% if form.amount.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.amount.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- Descrizione -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2"><i data-lucide="edit-3" class="w-4 h-4"></i> Descrizione</label>
      {{ form.description }}
      {% if form.description.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.description.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- Categoria -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2"><i data-lucide="tag" class="w-4 h-4"></i> Categoria</label>
      
      <select name="category" id="id_category" 
              class="border border-gray-300 px-4 py-2 rounded-lg w-full mb-3 focus:ring-2 focus:ring-blue-500">
        <option value="">-- Seleziona categoria --</option>
        {% for category in form.category.field.queryset %}
          <option value="{{ category.id }}" 
                  {% if form.category.value == category.id|stringformat:"s" %}selected{% endif %}>
            {{ category.get_type_display }} - {{ category.name }}
            {% if category.is_global %}<i data-lucide="globe" class="w-4 h-4"></i>{% else %}<i data-lucide="user" class="w-4 h-4"></i>{% endif %}
          </option>
        {% endfor %}
        <option value="new"><i data-lucide="plus" class="w-4 h-4"></i> Crea nuova categoria</option>
      </select>
      
      <div id="newCategorySection" class="hidden space-y-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">Nome categoria</label>
          <input type="text" name="new_category_name" id="new_category_input" 
                 placeholder="Es: Ristoranti" 
                 class="border border-gray-300 px-3 py-2 rounded-lg w-full focus:ring-2 focus:ring-blue-500"
                 maxlength="100">
        </div>
        
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Tipo</label>
            <select name="category_type" id="category_type" 
                    class="border border-gray-300 px-3 py-2 rounded-lg w-full focus:ring-2 focus:ring-blue-500">
              <option value="EX"><i data-lucide="minus-circle" class="w-4 h-4"></i> Spesa</option>
              <option value="IN"><i data-lucide="plus-circle" class="w-4 h-4"></i> Entrata</option>
            </select>
          </div>
          
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Colore</label>
            <input type="color" name="category_color" id="category_color" 
                   value="#3B82F6"
                   class="border border-gray-300 rounded-lg w-full h-10 cursor-pointer">
          </div>
        </div>
        
        <button type="button" id="cancelNewCategory"
                class="text-sm text-blue-600 hover:text-blue-800 font-medium">
          ← Torna alla selezione
        </button>
      </div>
      
      {% if form.category.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.category.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- Note -->
    {% if form.notes %}
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2"><i data-lucide="note" class="w-4 h-4"></i> Note</label>
      {{ form.notes }}
      {% if form.notes.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.notes.errors|join:", " }}</p>
      {% endif %}
    </div>
    {% endif %}
    
    <!-- Errori generali del form -->
    {% if form.non_field_errors %}
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
      <p class="text-red-600 font-semibold">{{ form.non_field_errors|join:", " }}</p>
    </div>
    {% endif %}
    
    <!-- Pulsanti -->
    <div class="flex gap-4 pt-4 border-t">
      <button type="submit" 
              class="flex-1 bg-emerald-600 text-white py-3 px-6 rounded-lg hover:bg-emerald-700 font-semibold shadow-lg transition">
        <i data-lucide="save" class="w-4 h-4"></i> Salva
      </button>
      <a href="{% url 'core:dashboard' %}" 
         class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 font-semibold text-center shadow-lg transition">
        <i data-lucide="x" class="w-4 h-4"></i> Annulla
      </a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const categorySelect = document.getElementById('id_category');
  const newCategorySection = document.getElementById('newCategorySection');
  const newCategoryInput = document.getElementById('new_category_input');
  const cancelBtn = document.getElementById('cancelNewCategory');
  
  categorySelect.addEventListener('change', function() {
    if (this.value === 'new') {
      newCategorySection.classList.remove('hidden');
      newCategoryInput.focus();
      this.value = '';
    } else {
      newCategorySection.classList.add('hidden');
      newCategoryInput.value = '';
    }
  });
  
  cancelBtn.addEventListener('click', function() {
    newCategorySection.classList.add('hidden');
    newCategoryInput.value = '';
    categorySelect.value = '';
  });
  
  document.getElementById('transactionForm').addEventListener('submit', function(e) {
    const selectedCategory = categorySelect.value;
    const newCategoryName = newCategoryInput.value.trim();
    
    if (!selectedCategory && !newCategoryName) {
      e.preventDefault();
      alert('Devi selezionare una categoria esistente o crearne una nuova!');
      return false;
    }
    
    if (newCategorySection.classList.contains('hidden') === false && !newCategoryName) {
      e.preventDefault();
      alert('Inserisci un nome per la nuova categoria!');
      newCategoryInput.focus();
      return false;
    }
  });
});
</script>
{% endblock %}