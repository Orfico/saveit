from django import forms
from .models import Transaction, Category
from decimal import Decimal
from django.db import models

class TransactionForm(forms.ModelForm):
    # Campo virtuale per il tipo (non salvato nel DB)
    type = forms.ChoiceField(
        choices=[
            ('income', 'Entrata'),
            ('expense', 'Uscita'),
        ],
        widget=forms.RadioSelect(attrs={
            'class': 'w-4 h-4 text-blue-600 focus:ring-blue-500'
        }),
        label='Tipo di Transazione',
        initial='expense'
    )
    
    # Campi per creare nuova categoria al volo
    new_category_name = forms.CharField(
        max_length=100,
        required=False,
        widget=forms.HiddenInput()
    )
    category_type = forms.CharField(
        max_length=2,
        required=False,
        widget=forms.HiddenInput()
    )
    category_color = forms.CharField(
        max_length=7,
        required=False,
        widget=forms.HiddenInput()
    )
    
    class Meta:
        model = Transaction
        fields = ['amount', 'category', 'description', 'date', 'notes', 'is_recurring']
        widgets = {
            'amount': forms.NumberInput(attrs={
                'class': 'w-full border border-gray-300 px-4 py-2.5 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
                'step': '0.01',
                'min': '0.01',
                'placeholder': '0.00'
            }),
            'category': forms.Select(attrs={
                'class': 'w-full border border-gray-300 px-4 py-2.5 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
            }),
            'description': forms.Textarea(attrs={
                'class': 'w-full border border-gray-300 px-4 py-2.5 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
                'rows': 3,
                'placeholder': 'Es: Spesa al supermercato...'
            }),
            'date': forms.DateInput(attrs={
                'class': 'w-full border border-gray-300 px-4 py-2.5 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
                'type': 'date'
            }),
            'notes': forms.Textarea(attrs={
                'class': 'w-full border border-gray-300 px-4 py-2.5 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
                'rows': 2,
                'placeholder': 'Note aggiuntive (opzionale)...'
            }),
            'is_recurring': forms.CheckboxInput(attrs={
                'class': 'sr-only peer'  # Hidden checkbox per il toggle switch
            }),
        }
        labels = {
            'amount': 'Importo (â‚¬)',
            'category': 'Categoria',
            'description': 'Descrizione',
            'date': 'Data',
            'notes': 'Note',
            'is_recurring': 'Ripeti automaticamente ogni mese',
        }
        help_texts = {
            'is_recurring': 'Perfetto per affitto, stipendio, abbonamenti, bollette ricorrenti',
        }
    
    def __init__(self, *args, **kwargs):
        user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)
        
        # Filtra categorie per l'utente
        if user:
            self.fields['category'].queryset = Category.objects.filter(
                models.Q(user=user) | models.Q(scope=Category.GLOBAL)
            )
        
        # Se stiamo modificando una transazione esistente, popola il campo type
        if self.instance.pk:
            if self.instance.amount > 0:
                self.fields['type'].initial = 'income'
            else:
                self.fields['type'].initial = 'expense'
    
    def clean(self):
        cleaned_data = super().clean()
        amount = cleaned_data.get('amount')
        transaction_type = cleaned_data.get('type')
        
        if amount and transaction_type:
            # Converti amount in positivo/negativo basandosi sul tipo
            amount = abs(Decimal(str(amount)))  # Rendi sempre positivo prima
            
            if transaction_type == 'expense':
                cleaned_data['amount'] = -amount  # Uscite = negative
            else:
                cleaned_data['amount'] = amount   # Entrate = positive
        
        return cleaned_data