{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Modifica{% else %}Nuova{% endif %} Transazione{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
  <h1 class="text-2xl sm:text-3xl font-bold mb-6 sm:mb-8 text-gray-800 flex items-center gap-3">
    {% if form.instance.pk %}
      <i data-lucide="edit" class="w-5 h-5 sm:w-6 sm:h-6"></i> Modifica Transazione
    {% else %}
      <i data-lucide="plus" class="w-5 h-5 sm:w-6 sm:h-6"></i> Nuova Transazione
    {% endif %}
  </h1>
  
  <form method="post" class="space-y-6" id="transactionForm">
    {% csrf_token %}
    {% csrf_token %}

<!-- üî¥ DEBUG: Mostra TUTTI gli errori -->
{% if form.errors %}
<div class="bg-red-100 border-2 border-red-500 rounded-lg p-4 mb-6">
  <h3 class="font-bold text-red-800 mb-2">‚ö†Ô∏è Errori nel Form:</h3>
  <ul class="list-disc list-inside text-red-700">
    {% for field, errors in form.errors.items %}
      <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}
    
    <!-- ‚úÖ TIPO TRANSAZIONE (ENTRATA/USCITA) -->
    <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-200">
      <label class="block text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
        <i data-lucide="activity" class="w-4 h-4"></i> Tipo di Transazione
      </label>
      <div class="flex gap-6">
        {% for value, label in form.type.field.choices %}
        <label class="flex items-center space-x-2 cursor-pointer">
          <input type="radio" name="type" value="{{ value }}" 
                 {% if form.type.value == value or form.initial.type == value %}checked{% endif %}
                 class="w-4 h-4 text-blue-600 focus:ring-blue-500">
          <span class="text-base sm:text-lg">{{ label }}</span>
        </label>
        {% endfor %}
      </div>
      {% if form.type.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.type.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- Data -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
        <i data-lucide="calendar" class="w-4 h-4"></i> Data
      </label>
      {{ form.date }}
      {% if form.date.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.date.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- Importo -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
        <i data-lucide="euro" class="w-4 h-4"></i> Importo (‚Ç¨)
      </label>
      {{ form.amount }}
      <p class="text-xs text-gray-600 mt-1">Inserisci sempre un valore positivo (es: 50.00)</p>
      {% if form.amount.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.amount.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- Descrizione -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
        <i data-lucide="edit-3" class="w-4 h-4"></i> Descrizione
      </label>
      {{ form.description }}
      {% if form.description.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.description.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- Categoria -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
        <i data-lucide="tag" class="w-4 h-4"></i> Categoria
      </label>
      
      <select name="category" id="id_category" 
              class="border border-gray-300 px-4 py-2 rounded-lg w-full mb-3 focus:ring-2 focus:ring-blue-500">
        <option value="">-- Seleziona categoria --</option>
        {% for category in form.category.field.queryset %}
          <option value="{{ category.id }}" 
                  {% if form.category.value == category.id|stringformat:"s" %}selected{% endif %}>
            {{ category.get_type_display }} - {{ category.name }}
          </option>
        {% endfor %}
        <option value="new">‚ûï Crea nuova categoria</option>
      </select>
      
      <div id="newCategorySection" class="hidden space-y-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">Nome categoria</label>
          {{ form.new_category_name }}
        </div>
        
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Tipo</label>
            {{ form.category_type }}
          </div>
          
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Colore</label>
            {{ form.category_color }}
          </div>
        </div>
        
        <button type="button" id="cancelNewCategory"
                class="text-sm text-blue-600 hover:text-blue-800 font-medium">
          ‚Üê Torna alla selezione
        </button>
      </div>
      
      {% if form.category.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.category.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- Note -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
        <i data-lucide="file-text" class="w-4 h-4"></i> Note (opzionale)
      </label>
      {{ form.notes }}
      {% if form.notes.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.notes.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- ‚úÖ SEZIONE RICORRENZA MENSILE - FUNZIONANTE -->
    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl p-4 sm:p-5">
      <div class="flex items-start gap-4">
        <!-- Toggle Switch Custom -->
        <div class="flex-shrink-0 pt-1">
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" 
                   name="is_recurring" 
                   id="{{ form.is_recurring.id_for_label }}"
                   {% if form.is_recurring.value or form.initial.is_recurring %}checked{% endif %}
                   class="sr-only peer">
            <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
          </label>
        </div>
        
        <!-- Contenuto -->
        <div class="flex-1">
          <label for="{{ form.is_recurring.id_for_label }}" class="text-sm sm:text-base font-semibold text-gray-900 cursor-pointer flex items-center gap-2">
            <i data-lucide="repeat" class="w-4 h-4 sm:w-5 sm:h-5 text-purple-600"></i>
            Ripeti automaticamente ogni mese
          </label>
          <p class="text-xs sm:text-sm text-gray-600 mt-1.5 leading-relaxed">
            Perfetto per affitto, stipendio, abbonamenti, bollette ricorrenti. La transazione verr√† duplicata automaticamente nello stesso giorno ogni mese.
          </p>
          
          {% if form.instance.pk and form.instance.is_recurring %}
            <div class="mt-3 flex items-start gap-2 text-xs sm:text-sm text-purple-800 bg-purple-100 px-3 py-2 rounded-lg">
              <i data-lucide="info" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
              <div>
                <p class="font-semibold">‚úì Transazione ricorrente attiva</p>
                <p class="mt-1 text-purple-700">Disattiva l'interruttore per interrompere le duplicazioni future. Le transazioni gi√† create rimarranno.</p>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
      {% if form.is_recurring.errors %}
        <p class="mt-2 text-sm text-red-600">{{ form.is_recurring.errors|join:", " }}</p>
      {% endif %}
    </div>
    
    <!-- Errori generali -->
    {% if form.non_field_errors %}
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
      <p class="text-red-600 font-semibold">{{ form.non_field_errors|join:", " }}</p>
    </div>
    {% endif %}
    
    <!-- Pulsanti -->
    <div class="flex flex-col-reverse sm:flex-row gap-3 sm:gap-4 pt-4 border-t">
      {% if form.instance.pk %}
        <!-- Bottone Delete (solo in modalit√† edit) -->
        <button type="button" 
                onclick="if(confirm('Are you sure you want to delete this transaction?')) { document.getElementById('deleteForm').submit(); }"
                class="flex-1 bg-red-600 text-white py-3 px-6 rounded-lg hover:bg-red-700 font-semibold shadow-lg transition flex items-center justify-center gap-2">
          <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
        </button>
      {% endif %}
      
      <a href="{% url 'core:transaction_list' %}" 
        class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 font-semibold text-center shadow-lg transition flex items-center justify-center gap-2">
        <i data-lucide="x" class="w-4 h-4"></i> Cancel
      </a>
      
      <button type="submit" 
              class="flex-1 bg-gradient-to-r from-emerald-600 to-green-600 text-white py-3 px-6 rounded-lg hover:from-emerald-700 hover:to-green-700 font-semibold shadow-lg transition flex items-center justify-center gap-2">
        <i data-lucide="save" class="w-4 h-4"></i> Save
      </button>
    </div>

    <!-- Form nascosto per delete -->
    {% if form.instance.pk %}
    <form id="deleteForm" method="post" action="{% url 'core:transaction_delete' form.instance.pk %}" class="hidden">
      {% csrf_token %}
    </form>
    {% endif %}
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Inizializza Lucide icons
  lucide.createIcons();
  
  const categorySelect = document.getElementById('id_category');
  const newCategorySection = document.getElementById('newCategorySection');
  const newCategoryInput = document.getElementById('new_category_input');
  const cancelBtn = document.getElementById('cancelNewCategory');
  
  categorySelect.addEventListener('change', function() {
    if (this.value === 'new') {
      newCategorySection.classList.remove('hidden');
      newCategoryInput.focus();
      this.value = '';
    } else {
      newCategorySection.classList.add('hidden');
      newCategoryInput.value = '';
    }
  });
  
  cancelBtn.addEventListener('click', function() {
    newCategorySection.classList.add('hidden');
    newCategoryInput.value = '';
    categorySelect.value = '';
  });
  
  document.getElementById('transactionForm').addEventListener('submit', function(e) {
    const selectedCategory = categorySelect.value;
    const newCategoryName = newCategoryInput.value.trim();
    
    if (!selectedCategory && !newCategoryName) {
      e.preventDefault();
      alert('Devi selezionare una categoria esistente o crearne una nuova!');
      return false;
    }
    
    if (newCategorySection.classList.contains('hidden') === false && !newCategoryName) {
      e.preventDefault();
      alert('Inserisci un nome per la nuova categoria!');
      newCategoryInput.focus();
      return false;
    }
  });
});
</script>
{% endblock %}